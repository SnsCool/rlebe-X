仕様書：Discordリアクション（❤️）・投稿数 月次集計 Bot（LikeCounter）
1. 目的
指定したDiscordサーバー内の指定チャンネルについて、指定月（例：2025-12）の期間におけるユーザー別の
❤️リアクション数（合計）
投稿数（メッセージ数）
を集計し、CSVとして出力・配布する。

2. 対象範囲
2.1 対象データ
Discordサーバー内の 特定チャンネル（1つまたは複数）
期間：月単位（例：2025-12）
集計対象：チャンネル内のメッセージ
投稿者（ユーザー）ごとに投稿数をカウント
各メッセージに付いたリアクションのうち、指定絵文字（既定：❤️）のみ合算
2.2 対象外
スレッド単位集計（当初要望にあったが、最終は「チャンネル情報」が要件）
Discord標準UIのみでの自動集計（Discord自体に標準機能がないため）

3. 成果物（アウトプット）
3.1 CSV出力
ファイル名：
指定月の場合：YYYY-MM_report.csv（例：2025-12_report.csv）
先月の場合：last_month_report.csv（オプション）
文字コード：UTF-8
カラム：
name（表示名）
hearts（❤️数合計）
posts（投稿数）
3.2 ソート順
hearts 降順 → posts 降順 → name 昇順

4. 操作仕様（ユーザー体験）
4.1 スラッシュコマンド
コマンド：/report
引数：
month: 文字列
形式：YYYY-MM（例：2025-12）
もしくは last（先月）
4.2 返信動作（最終採用）
/report 実行者に対し DMでCSVファイルを添付送信
コマンド実行チャンネル側には **実行者にだけ見える通知（ephemeral）**を表示
例：「DMにCSVを送りました。」
※「チャンネルにCSVを投稿する」案も検討されたが、最終的にDM送信を採用。

5. 期間仕様（時間・タイムゾーン）
基準タイムゾーン：JST（UTC+9）
月の範囲：
指定月：YYYY-MM-01 00:00:00 JST 〜 翌月1日 00:00:00 JST
last：当月1日 00:00:00 JST を終端として、先月1日から当月1日まで
内部処理はDiscord API都合でUTCに変換して検索する。

6. 権限・前提条件
6.1 Botのサーバー参加（招待）
OAuth2 Scopes：
bot
applications.commands（スラッシュコマンド出現に必須）
Bot Permissions（最低限・推奨）：
View Channels
Read Message History
※メッセージ履歴が読めないと集計不可
6.2 チャンネル側の許可（管理者が最初の1回だけ設定）
対象チャンネルに対して Bot に以下を許可：
View Channel
Read Message History
（必要に応じて）
Use Application Commands（環境によって候補に出ない場合の原因になり得る）
DMで送るため、ユーザー側で「サーバーメンバーからDMを許可」設定が必要な場合あり
6.3 Discord API Intent
Bot側で message_content intent を True にして起動（実装上は設定済み）
ただし今回の集計は「本文」ではなく「履歴アクセス」「リアクション参照」が主であり、環境によっては必須ではないが、既定でONとする。

7. システム構成・運用
7.1 実行形態
ローカル実行（Mac上でPython実行）
Botは 起動している間だけ動作する（ターミナル/プロセス停止で停止）
7.2 実行環境
OS：macOS
Python：3.9 系（ユーザー環境のスクショより）
依存ライブラリ：
discord.py（2.x系）
7.3 設定値（コード内）
GUILD_ID: サーバーID
CHANNEL_IDS: 対象チャンネルID配列（1つでも複数でも可）
HEART_EMOJI: 既定 "❤️"
EXCLUDE_BOTS: 既定 True（Bot投稿は集計対象外）
7.4 機密情報（トークン管理）
Botトークンは **環境変数 DISCORD_TOKEN**で渡す
スクショ・共有で漏えいした場合は 即Reset Token（会話中に実際に露出が発生）

8. エラーハンドリング／メッセージ
8.1 権限不足（Discord.Forbidden）
想定原因：
View Channel / Read Message History が不足
実行者のDM受信設定がOFF
動作：
ephemeralで「権限不足またはDM不可」を通知
8.2 ファイル/フォルダ関連（運用時のつまずき）
Finder上の“見た目の名前”と実体パスの不一致（空白/日本語/iCloud Desktop 等）
フォルダ名とファイル名の誤り（フォルダを .py として作る、.txt付与 等）
対応方針：
実体パスの確認を優先
.py ファイルとして保存されていることを必ず確認

9. 非機能要件
9.1 正確性
指定期間内のメッセージ履歴を全件走査（limit=None）
リアクションは該当絵文字のみ集計
9.2 パフォーマンス
過去ログが多いチャンネルは実行時間が長くなる可能性あり
必要に応じて：
対象チャンネル数を絞る
月次以外の範囲指定は現状なし
9.3 セキュリティ
トークンは環境変数で管理
トークンの露出時は即リセット
出力CSVにはユーザー名（表示名）が含まれるため取り扱い注意

10. 受け入れ条件（完了判定）
以下が満たされること：
Discordで / 入力時に /report が候補に出る
/report 実行で month=2025-12 を指定できる
実行後、実行者のDMにCSVが届く
CSVに name, hearts, posts が出力され、値が妥当である
権限不足時はエラーがユーザーに分かる形で返る

11. 今後の拡張候補（会話で出た案）
集計対象を「スレッド」に拡張（当初要望）
